import { motion, useAnimation } from "framer-motion";
import { JSX, useEffect } from "react";

type AnimationControls = ReturnType<typeof useAnimation>;

const EASE: number[] = [0.38, 0.01, 0.18, 1];
const ERASE_EASE: number[] = [0.6, 0, 0.4, 1];

function draw(ctrl: AnimationControls, dur: number, delay: number = 0): void {
    ctrl.start({ pathLength: 1, opacity: 1, transition: { duration: dur, delay, ease: EASE as any } });
}
function erase(ctrl: AnimationControls, dur: number): void {
    ctrl.start({ pathLength: 0, transition: { duration: dur, ease: ERASE_EASE as any } });
}
function resetCtrl(ctrl: AnimationControls): void {
    ctrl.set({ pathLength: 0, opacity: 0 });
}

const TREE_BODY =
    "M135.79 41.23 C136.26 35.29 127.96 34.07 122.46 41.93 C116.96 49.79 104.39 88.1 102.81 88.39 C101.23 88.68 113.74 48.27 112.98 43.67 C112.22 39.07 101.12 61.14 98.25 60.79 C95.38 60.44 96.79 39.78 95.79 41.58 C94.8 43.38 95.67 70.22 92.28 71.62 C88.89 73.02 75.38 44.14 75.44 49.96 C75.5 55.78 93.86 101.84 92.63 106.56 C91.4 111.28 71.81 86.82 68.07 78.26 C64.33 69.7 72.29 57.18 70.18 55.2 C68.08 53.22 57.78 67.6 55.44 66.38 C53.1 65.16 57.84 48.09 56.14 47.86 C54.44 47.63 42.86 57.24 45.26 64.98 C47.66 72.73 73.22 92.12 70.53 94.33 C67.84 96.54 36.61 78.09 29.12 78.26 C21.63 78.44 22.39 92.58 25.61 95.38 C28.83 98.18 46.08 91.48 48.42 95.03 C50.76 98.58 38.83 113.02 39.65 116.69 C40.47 120.36 51.11 120.01 53.33 117.04 C55.55 114.07 49.06 100.79 52.98 98.87 C56.9 96.95 75.14 102.31 76.84 105.51 C78.54 108.71 61.76 116.23 63.16 118.09 C64.56 119.95 81.75 109.47 85.26 116.69 C88.77 123.91 84.09 162.86 84.21 161.41 C84.33 159.95 92.92 117.86 85.96 107.96 C79.0 98.06 49.65 104.99 42.46 102.02 C35.27 99.05 37.9 91.36 42.81 90.14 C47.72 88.92 70.35 98.23 71.93 94.68 C73.51 91.13 53.8 72.21 52.28 68.83 C50.76 65.45 60.0 76.22 62.81 74.42 C65.62 72.62 68.42 57.24 69.12 58.0 C69.82 58.76 62.93 70.57 67.02 78.96 C71.11 87.34 88.83 114.25 93.68 108.31 C98.53 102.37 95.5 51.01 96.14 43.32 C96.78 35.63 94.85 61.9 97.54 62.19 C100.23 62.48 111.46 40.53 112.28 45.07 C113.1 49.61 100.47 88.92 102.46 89.44 C104.45 89.96 118.24 54.56 124.21 48.21 C130.17 41.86 139.3 46.29 138.25 51.36 C137.2 56.43 117.54 74.07 117.89 78.61 C118.24 83.15 141.05 77.39 140.35 78.61 C139.65 79.83 119.7 81.06 113.68 85.95 C107.66 90.84 99.24 106.74 104.21 107.96 C109.18 109.18 143.8 89.38 143.51 93.28 C143.22 97.18 106.09 113.9 102.46 131.37 C98.83 148.84 128.65 186.98 121.75 198.1 C114.85 209.22 68.07 202.06 61.05 198.1 C54.03 194.14 79.3 175.04 79.65 174.34 C80.0 173.64 71.93 189.83 63.16 193.91 C54.39 197.99 13.57 197.98 27.02 198.8 C40.47 199.62 129.12 200.49 143.86 198.8 C158.6 197.11 122.34 197.1 115.44 188.66 C108.54 180.22 103.4 159.96 102.46 148.14 C101.52 136.32 105.78 121.23 109.82 117.74 C113.85 114.24 121.7 128.74 126.67 127.17 C131.64 125.6 141.35 111.34 139.65 108.31 C137.95 105.28 115.26 109.77 116.49 109.01 C117.72 108.25 143.86 105.34 147.02 103.77 C150.18 102.2 136.08 101.61 135.44 99.57 C134.8 97.53 148.13 90.26 143.16 91.54 C138.19 92.82 111.11 107.26 105.61 107.26 C100.11 107.26 101.12 97.77 110.18 91.54 C119.24 85.31 158.42 72.21 160.0 69.88 C161.58 67.55 123.68 82.34 119.65 77.56 Z";

const LEAF_PATHS: string[] = [
    "M42.46 131.37 C42.58 132.88 43.45 137.77 44.21 140.1 C44.97 142.43 45.73 143.59 47.02 145.34 C48.31 147.09 50.7 149.42 51.93 150.58 C53.16 151.74 54.39 152.33 55.85 153.09 C58.77 154.48 60.7 155.12 62.63 155.76 C64.5 156.0 65.96 156.17 67.42 156.34 C68.83 156.29 69.47 156.17 69.82 155.47 C68.42 155.12 62.98 154.55 61.05 154.08 C59.12 153.62 58.25 152.68 58.43 152.21 C61.23 151.86 62.99 150.7 63.51 149.18 C63.74 148.31 63.68 146.91 63.51 146.04 C63.04 144.7 62.46 143.94 60.0 141.5 C57.72 140.05 51.52 136.96 48.77 135.21 C46.02 133.46 44.56 131.66 43.51 131.02 Z",
    "M159.65 63.94 C159.71 64.76 159.59 66.73 159.3 68.13 C158.42 71.15 157.89 72.32 156.14 75.12 C155.44 75.99 154.56 76.86 153.68 77.56 C151.93 78.84 150.88 79.31 148.42 80.24 C147.37 80.36 146.32 80.18 144.56 80.01 C143.63 79.66 142.04 78.44 141.75 77.91 C141.4 76.68 141.4 75.64 141.75 74.77 C142.52 73.13 143.8 71.5 145.61 69.88 C147.31 68.54 150.23 67.02 154.39 65.33 C155.44 64.81 157.61 63.47 158.25 63.24 Z",
    "M85.26 109.01 C85.49 109.77 85.49 111.16 85.26 112.15 C84.5 114.08 83.86 114.95 81.4 117.39 C79.13 118.73 78.25 119.14 76.14 119.84 C73.39 120.19 70.7 120.13 69.47 119.84 C67.02 118.85 64.91 118.03 64.56 117.39 C65.44 116.29 67.02 114.95 74.04 109.36 C75.62 108.2 76.49 107.96 79.65 106.91 C80.65 106.74 82.46 106.91 83.86 107.61 Z",
    "M165.26 101.67 C164.04 101.55 162.11 102.37 160.0 104.11 C158.13 106.21 155.09 107.26 151.58 110.75 C150.47 112.56 149.88 114.08 149.82 116.34 C149.88 116.8 150.18 117.39 151.58 118.79 C152.28 119.08 155.61 119.2 157.54 118.79 C159.12 118.09 160.88 116.69 162.81 114.6 C164.21 112.15 165.49 108.43 165.61 106.56 C165.67 104.0 165.32 103.36 165.26 103.07 Z",
    "M76.84 50.66 C78.13 52.06 80.52 54.44 81.4 55.55 C84.15 59.28 85.67 61.84 86.67 64.64 C87.02 66.38 87.02 67.78 86.67 68.83 C86.02 69.88 84.21 70.92 82.11 70.57 C79.65 69.18 77.48 66.9 75.79 63.94 C75.44 62.72 74.74 58.7 75.79 52.06 Z",
    "M44.91 133.81 C47.01 135.56 51.93 138.52 59.3 142.55 C61.22 144.35 62.34 145.75 62.46 146.39 C62.58 148.26 62.46 148.84 61.75 149.88 C60.12 151.05 58.48 151.51 56.02 151.1 C53.75 149.88 51.0 147.32 48.07 143.59 C46.14 137.66 44.56 135.09 44.56 134.86 Z",
    "M54.74 49.26 C55.56 59.39 55.15 62.78 53.33 66.38 C52.75 67.14 51.81 67.72 49.82 68.13 C48.42 67.78 47.02 66.5 46.32 64.64 C45.9 62.13 46.02 59.33 47.72 55.2 C48.77 53.8 50.24 52.12 51.23 51.36 Z",
    "M29.82 79.66 C31.82 79.43 35.44 80.36 37.89 81.75 C40.0 83.32 41.28 85.84 41.4 86.65 C41.52 89.03 40.64 90.9 39.65 91.54 C38.78 91.66 37.19 91.42 36.49 90.84 C34.86 89.44 31.99 85.31 31.58 84.55 Z",
    "M137.19 110.75 C137.66 111.34 136.78 114.94 135.79 117.04 C134.04 119.84 131.23 122.63 129.82 123.68 C128.3 124.03 126.79 123.97 125.96 118.44 C126.66 117.5 128.42 116.34 136.49 111.45 Z",
    "M122.46 45.07 C122.58 44.37 123.45 42.56 124.21 41.93 C125.26 41.23 127.02 40.53 131.58 40.53 C133.1 41.06 135.09 42.27 135.79 44.02 C134.27 45.24 131.93 45.77 127.72 47.17 C125.55 47.4 123.86 46.82 122.81 45.77 Z",
    "M37.89 103.07 C39.94 103.82 41.4 104.81 42.46 107.61 C42.58 110.17 41.52 113.78 40.0 115.3 C39.3 114.6 37.54 111.45 36.14 107.96 C35.97 105.22 36.9 103.65 37.19 103.42 Z",
    "M120.0 138.0 C118.25 138.7 116.14 139.75 113.68 141.15 C111.76 142.72 110.18 144.52 110.18 144.99 C110.3 146.68 110.76 147.5 112.28 147.44 C113.68 147.09 115.56 146.1 116.49 145.34 C118.01 143.65 119.88 140.33 120.0 139.75 Z",
];

const FALL_PATHS: string[] = [
    "M51.93 172.59 C52.05 174.05 52.92 175.74 53.68 176.09 C56.38 177.37 58.36 177.54 60.7 177.14 C63.74 175.62 65.61 174.05 65.61 173.64 C65.44 173.0 63.68 172.18 60.35 171.2 C58.48 170.62 55.5 170.38 52.98 171.2 C52.46 171.66 52.28 171.89 51.93 172.59 Z",
    "M123.16 157.57 C126.38 161.18 135.62 170.55 138.25 172.94 C139.65 172.94 139.88 172.82 139.65 172.24 C137.08 169.56 126.96 159.32 124.21 156.87 Z",
    "M117.54 164.91 C118.12 167.35 120.29 171.83 121.81 174.75 C122.29 175.04 123.04 176.26 123.51 176.09 C123.51 175.04 121.17 170.79 120.23 168.81 C119.13 165.61 118.6 164.91 117.54 164.91 Z",
];

export default function TreeDraw(): JSX.Element {
    const cBody = useAnimation();
    const cLeaves: AnimationControls[] = LEAF_PATHS.map(() => useAnimation());
    const cFall: AnimationControls[] = FALL_PATHS.map(() => useAnimation());

    const allCtrls: AnimationControls[] = [cBody, ...cLeaves, ...cFall];

    useEffect(() => {
        const loop = async (): Promise<void> => {
            while (true) {
                allCtrls.forEach(resetCtrl);
                await new Promise<void>(r => setTimeout(r, 400));

                let t = 0;
                draw(cBody, 4.5, t); t += 4.2;
                cLeaves.forEach(c => { draw(c, 0.45, t); t += 0.38; });
                cFall.forEach(c => { draw(c, 0.32, t); t += 0.28; });

                const totalMs = t * 1000;
                await new Promise<void>(r => setTimeout(r, totalMs + 2500));

                for (const c of [...cFall].reverse()) { erase(c, 0.22); await new Promise<void>(r => setTimeout(r, 180)); }
                for (const c of [...cLeaves].reverse()) { erase(c, 0.28); await new Promise<void>(r => setTimeout(r, 220)); }
                erase(cBody, 3.5);
                await new Promise<void>(r => setTimeout(r, 4000));
            }
        };
        loop();
    }, []);

    const S = {
        stroke: "#FAF9F6", // Cream color
        strokeLinecap: "round" as const,
        strokeLinejoin: "round" as const,
        fill: "transparent",
    };
    const init = { pathLength: 0, opacity: 0 };

    return (
        <div style={{
            display: "flex", alignItems: "center", justifyContent: "center",
            width: "100%", height: "100%", background: "transparent",
        }}>
            <svg width="250" height="250" viewBox="0 0 200 225" fill="none">
                <motion.path d={TREE_BODY} {...S} strokeWidth={1.6}
                    animate={cBody} initial={init} />

                {LEAF_PATHS.map((d, i) => (
                    <motion.path key={`leaf-${i}`} d={d} {...S} strokeWidth={1.3}
                        animate={cLeaves[i]} initial={init} />
                ))}

                {FALL_PATHS.map((d, i) => (
                    <motion.path key={`fall-${i}`} d={d} {...S} strokeWidth={1.2}
                        animate={cFall[i]} initial={init} />
                ))}
            </svg>
        </div>
    );
}